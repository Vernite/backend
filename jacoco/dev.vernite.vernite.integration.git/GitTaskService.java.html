<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitTaskService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vernite</a> &gt; <a href="index.source.html" class="el_package">dev.vernite.vernite.integration.git</a> &gt; <span class="el_source">GitTaskService.java</span></div><h1>GitTaskService.java</h1><pre class="source lang-java linenums">/*
 * BSD 2-Clause License
 * 
 * Copyright (c) 2022, [Aleksandra Serba, Marcin Czerniak, Bartosz Wawrzyniak, Adrian Antkowiak]
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 
 * 1. Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

package dev.vernite.vernite.integration.git;

import java.util.List;

import dev.vernite.vernite.integration.git.github.GitHubService;
import dev.vernite.vernite.project.Project;
import dev.vernite.vernite.release.Release;
import dev.vernite.vernite.task.Task;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

/**
 * Service for managing task connected to any git service.
 */
@Service
@Component
<span class="fc" id="L49">public class GitTaskService {</span>
    @Autowired
    private GitHubService gitHubService;

    /**
     * Handle issue action for a given task.
     * 
     * @param action the action to handle.
     * @param task   the task to handle.
     * @return flux with changed issues.
     */
    public Flux&lt;Issue&gt; handleIssueAction(IssueAction action, Task task) {
<span class="nc bnc" id="L61" title="All 4 branches missed.">        switch (action) {</span>
            case ATTACH:
<span class="nc" id="L63">                return connectIssue(task, action.getIssue()).flux();</span>
            case CREATE:
<span class="nc" id="L65">                return createIssue(task);</span>
            case DETACH:
<span class="nc" id="L67">                deleteIssue(task);</span>
        }
<span class="nc" id="L69">        return Flux.empty();</span>
    }

    /**
     * Creates issue in appropriate git service.
     * 
     * @param task must not be {@literal null}.
     * @return Mono with created issue.
     */
    public Flux&lt;Issue&gt; createIssue(Task task) {
<span class="nc" id="L79">        return Flux.concat(List.of(gitHubService.createIssue(task)));</span>
    }

    /**
     * Applies changes to issue in appropriate git service.
     * 
     * @param task must not be {@literal null}. Should have changed since last patch
     *             or since creation.
     * @return Mono with patched issue.
     */
    public Flux&lt;Issue&gt; patchIssue(Task task) {
<span class="fc" id="L90">        return Flux.concat(List.of(gitHubService.patchIssue(task), gitHubService.patchPullRequest(task)));</span>
    }

    /**
     * Gets issues from git integrations for given project.
     * 
     * @param project must not be {@literal null}; must be entity from database.
     * @return Flux with issues.
     */
    public Flux&lt;Issue&gt; getIssues(Project project) {
<span class="fc" id="L100">        return Flux.concat(List.of(gitHubService.getIssues(project)));</span>
    }

    /**
     * Connects given task with issue from git service.
     * 
     * @param task  must not be {@literal null}; must be entity from database.
     * @param issue must not be {@literal null}; must be returned by getIssues.
     * @return Mono with connected task.
     */
    public Mono&lt;Issue&gt; connectIssue(Task task, Issue issue) {
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if (&quot;github&quot;.equals(issue.getService())) {</span>
<span class="nc" id="L112">            return gitHubService.connectIssue(task, issue.getId());</span>
        }
<span class="fc" id="L114">        return Mono.empty();</span>
    }

    /**
     * Deletes git issue connections for given task.
     * 
     * @param task must not be {@literal null}; must be entity from database.
     */
    public void deleteIssue(Task task) {
<span class="nc" id="L123">        gitHubService.deleteIssue(task);</span>
<span class="nc" id="L124">    }</span>

    /**
     * Handles pull action for a given task.
     * 
     * @param action the action to handle.
     * @param task   the task to handle.
     * @return flux with changed pull requests.
     */
    public Flux&lt;PullRequest&gt; handlePullAction(PullAction action, Task task) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (action.equals(PullAction.ATTACH)) {</span>
<span class="nc" id="L135">            return connectPullRequest(task, action.getPullRequest()).flux();</span>
        } else {
<span class="nc" id="L137">            deletePullRequest(task);</span>
        }
<span class="nc" id="L139">        return Flux.empty();</span>
    }

    /**
     * Gets pull requests from git integrations for given project.
     * 
     * @param project must not be {@literal null}; must be entity from database.
     * @return Flux with pull requests.
     */
    public Flux&lt;PullRequest&gt; getPullRequests(Project project) {
<span class="fc" id="L149">        return Flux.concat(List.of(gitHubService.getPullRequests(project)));</span>
    }

    /**
     * Connects given task with pull request from git service.
     * 
     * @param task        must not be {@literal null}; must be entity from database.
     * @param pullRequest must not be {@literal null}; must be returned by
     *                    getPullRequests.
     * @return Mono with connected pull request.
     */
    public Mono&lt;PullRequest&gt; connectPullRequest(Task task, PullRequest pullRequest) {
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (&quot;github&quot;.equals(pullRequest.getService())) {</span>
<span class="nc" id="L162">            return gitHubService.connectPullRequest(task, pullRequest.getId());</span>
        }
<span class="fc" id="L164">        return Mono.empty();</span>
    }

    /**
     * Deletes git pull request connections for given task.
     * 
     * @param task must not be {@literal null}; must be entity from database.
     */
    public void deletePullRequest(Task task) {
<span class="nc" id="L173">        gitHubService.deletePullRequest(task);</span>
<span class="nc" id="L174">    }</span>

    public Mono&lt;Long&gt; publishRelease(Release release, String branch) {
<span class="nc" id="L177">        return gitHubService.publishRelease(release, branch);</span>
    }

    public Flux&lt;Branch&gt; getBranches(Project project) {
<span class="nc" id="L181">        return Flux.concat(List.of(gitHubService.getBranches(project)));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>